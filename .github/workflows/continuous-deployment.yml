name: Continuous Deployment

on:
  push:
    branches:
      - main

jobs:
  # GitHub Actions fails if any "with" parameter is empty when using reusable workflows, so needs || fallbacks
  check-release:
    uses: chime-sps/champss/.github/workflows/release.yml@main
    secrets: inherit
  latest-image:
    needs: check-release
    # only true if merging automated release PR
    if: ${{ needs.release.outputs.release_created == 'false' }}
    uses: chime-sps/champss/.github/workflows/image.yml@main
    secrets: inherit
    with:
      image_tag: 'latest'
      build_locally: false
  version-image:
    needs: check-release
    if: ${{ needs.release.outputs.release_created == 'true' }}
    uses: chime-sps/champss/.github/workflows/image.yml@main
    secrets: inherit
    with:
      # E.g. v1.0.0, only set if merging automated release PR
      image_tag: ${{ needs.release.outputs.release_tag || 'none' }}
      build_locally: false

